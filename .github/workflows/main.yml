name: Package scripts
on:
  push:
    tags: 
       - "v*"
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
jobs:
  pyinstaller-build:
    runs-on: ${{ matrix.os }}
    strategy:
        matrix:
          os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Create Executable
        uses: sayyid5416/pyinstaller@v1
        with:
          python_ver: '3.13'
          spec: 'App/build.spec'
          requirements: 'requirements.txt'
          upload_exe_with_name: Pager-software-${{ matrix.os }}
          options: --onefile --name "Pager software" --windowed
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: Pager-${{ matrix.os }}
          path: dist/*

          
  release:
    needs: pyinstaller-build
    runs-on: ubuntu-latest

    steps:
      - name: Wait to avoid rate limits
        run: sleep 15
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
